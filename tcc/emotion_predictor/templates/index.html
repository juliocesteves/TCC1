{% extends "base.html" %} {% block content %}

<div>

    <form id="myform" class="" method="post" enctype="multipart/form-data">
        <div class="form-inline">

            {% csrf_token %}

            <div class="form-group mb-4">
                <label class="">Selecionar video/imagem</label>
                <div class="col-md-12">
                    <input class="form-control" type="file" accept="video/*;capture=camcorder" name="file">
                </div>
            </div>

            <input id="video_url" type="hidden" name="video_url" value="">

        </div>

        <label class="">MÃ©dia de frames: </label>
        <div class="form-inline form-group">
            <div class="col-md-3">
                <input class="form-control input-sm" type="number" name="num_frames" value="1">
            </div>

            <div class="form-group mb-2">
                <div class="col-md-1">
                    <a class="form-control pointer" onclick="accessWebCam()"><i class="fa fa-camera-retro" style="background-color; white;"></i></a>
                </div>
            </div>

            <div class="form-group mb-3  mb-2">
                <input class="form-control pointer" type="submit">
            </div>
        </div>

    </form>

    <div id="video_container" style="display:none; margin:auto;">
        <div class="form-group" style="display:flex;">
            <video width="320" height="240" autoplay style="margin: auto;" id="my_video"></video>
            <canvas width="320" height="240" style="margin: auto; display: none;" id="my_canvas"></canvas>
            <img width="320" height="240" id="photo" style="margin: auto; display: none;">
        </div>
        <div style="display: flex;">
            <div class="" style="margin: auto; font-size:3em;">
                <a class="pointer" id="record" onclick="record()"><i class="fa fa-play"></i></a>
                <a class="pointer" id="stop" onclick="stop()"><i class="fa fa-stop"></i></a>
                <a class="pointer" id="shot" onclick="takepicture()"><i class="fa fa-camera"></i></a>
            </div>
        </div>
    </div>

    <div id="charts">
        <canvas id="myChart" width="400" height="150"></canvas>
        <canvas id="angry" width="400" height="150"></canvas>
        <canvas id="disgust" width="400" height="150"></canvas>
        <canvas id="fear" width="400" height="150"></canvas>
        <canvas id="happy" width="400" height="150"></canvas>
        <canvas id="neutral" width="400" height="150"></canvas>
        <canvas id="sad" width="400" height="150"></canvas>
        <canvas id="surprised" width="400" height="150"></canvas>
    </div>

</div>

<div id="loading-wrapper" style="display: none;">
  <div id="loading-text">LOADING</div>
  <div id="loading-content"></div>
</div>

<script>
    var data;
    var charts = [];

    function loadCharts(data) {
        var emotions = ["angry", "disgust", "fear", "happy", "neutral", "sad", "surprised"];
        var emotions_colors = {
            "angry": {
                backgroundColor: [
                    'rgba(255, 99, 132, 0.2)'
                ],
                borderColor: [
                    'rgba(255,99,132,1)'
                ],
                borderWidth: 1
            },
            "disgust": {
                backgroundColor: [
                    'rgba(50, 255, 132, 0.2)'
                ],
                borderColor: [
                    'rgba(8,255,132,1)'
                ],
                borderWidth: 1
            },
            "fear": {
                backgroundColor: [
                    'rgba(1, 1, 255, 0.2)'
                ],
                borderColor: [
                    'rgba(1,1,255,1)'
                ],
                borderWidth: 1
            },
            "happy": {
                backgroundColor: [
                    'rgba(255, 255, 132, 0.6)'
                ],
                borderColor: [
                    'rgba(255,255,0,1)'
                ],
                borderWidth: 1
            },
            "neutral": {
                backgroundColor: [
                    'rgba(150, 150, 150, 0.2)'
                ],
                borderColor: [
                    'rgba(100,100,100,1)'
                ],
                borderWidth: 1
            },
            "sad": {
                backgroundColor: [
                    'rgba(10, 10, 10, 0.5)'
                ],
                borderColor: [
                    'rgba(100,100,100,1)'
                ],
                borderWidth: 1
            },
            "surprised": {
                backgroundColor: [
                    'rgba(239, 0, 255, 0.2)'
                ],
                borderColor: [
                    'rgba(200,0,200,1)'
                ],
                borderWidth: 1
            },
        };
        var labels = []
        var chart_data = [];
        emotions.forEach(function(value) {
            chart_data.push({
                label: value,
                data: data[value],
                backgroundColor: emotions_colors[value].backgroundColor,
                borderColor: emotions_colors[value].borderColor,
                borderWidth: emotions_colors[value].borderWidth
            });
        });

        if (data["image"]) {
            var chart_data = [];
            var chart_data_values = [];
            emotions.forEach(function(value) {
                chart_data_values.push(data[value][0]);
            });
            chart_data.push({
                data: chart_data_values,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(50, 255, 132, 0.2)',
                    'rgba(1, 1, 255, 0.2)',
                    'rgba(255, 255, 132, 0.6)',
                    'rgba(150, 150, 150, 0.2)',
                    'rgba(10, 10, 10, 0.5)',
                    'rgba(239, 0, 255, 0.2)'
                ],
                borderColor: [
                    'rgba(255,99,132,1)',
                    'rgba(8,255,132,1)',
                    'rgba(1,1,255,1)',
                    'rgba(255,255,0,1)',
                    'rgba(100,100,100,1)',
                    'rgba(100,100,100,1)',
                    'rgba(200,0,200,1)'
                ],
                borderWidth: 1
            });

            for (var i = 0; i < charts.length; ++i) {
                charts[i].destroy();
            }
            charts = [];

            var ctx = document.getElementById("myChart").getContext('2d');
            var myChart = new Chart(ctx, {
                type: 'horizontalBar',
                data: {
                    labels: emotions,
                    datasets: chart_data
                },
                options: {
                    legend: {
                        display: false
                     },
                    scales: {
                        xAxes: [{
                            ticks: {
                                beginAtZero:true,
                                max: 1.0
                            }
                        }]
                    }
                }
            });
            charts.push(myChart);
            $("#charts canvas").each(function(element) {
                if (this.id != "myChart")
                    $(this).attr('style', 'display:none;');
            });
        }

        else {
            for (var i = 0; i < data["frame"].length; i++) {
                labels.push(i + 1);
            }

            for (var i = 0; i < charts.length; ++i) {
                charts[i].destroy();
            }
            charts = [];

            $("#charts canvas").each(function(element) {
                $(this).attr('style', '');
                var ctx = document.getElementById(this.id).getContext('2d');
                var text = (this.id == "myChart" ? 'All emotions' : this.id.capitalize());
                var id = this.id;
                var datasets = (this.id == "myChart" ? chart_data : chart_data.filter(function(obj) {
                    return obj.label == id
                }));

                var myChart = new Chart(ctx, {
                    type: 'line',
                    responsive: true,
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        title: {
                            display: true,
                            text: text
                        },
                        scales: {
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true,
                                    max: 1.0
                                },
                            }],
                            xAxes: [{
                                scaleLabel: {
                                    display: true,
                                    labelString: 'Frame'
                                }
                            }]
                        }
                    }

                });

                charts.push(myChart);
            });
        }

    }

    $(document).ready(function() {
        {% if data %}
        data = {{ data|safe }}
        {% else %}
        data = JSON.parse('{"frame":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25],"face":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"angry":[0,0,0.5639291405677795,0.8767013549804688,0.79863440990448,0,0,0,0,0.9304578900337219,0,0,0.615980327129364,0.36672481894493103,0.5391800403594971,0,0,0.2858274281024933,0.11155682057142258,0.13703954219818115,0,0,0,0.34399932622909546,0.31784647703170776],"disgust":[0,0,0.05330418050289154,0.09612230211496353,0.18439458310604095,0,0,0,0,0.007860004901885986,0,0,0.11407390236854553,0.016010107472538948,0.10439107567071915,0,0,0.03415917977690697,0.05141221731901169,0.08414515852928162,0,0,0,0.0029581827111542225,0.09082947671413422],"fear":[0,0,0.09174270927906036,0.014095993712544441,0.006083183456212282,0,0,0,0,0.02117716334760189,0,0,0.08870359510183334,0.2666875422000885,0.10790544003248215,0,0,0.06928373873233795,0.03908460959792137,0.030012594535946846,0,0,0,0.1399497389793396,0.24590981006622314],"happy":[0,0,0.0003072687250096351,0.000005190561296330998,0.0000010323540209355997,0,0,0,0,2.801135963181878e-7,0,0,0.00003185846799169667,0.000050719532737275586,0.000003818764980678679,0,0,0.00033272107248194516,0.00015163769421633333,0.00003920612653018907,0,0,0,0.0004273399244993925,0.000018344964701100253],"sad":[0,0,0.2796233296394348,0.011849619448184967,0.01043385174125433,0,0,0,0,0.0393226258456707,0,0,0.17666760087013245,0.3429805338382721,0.24363179504871368,0,0,0.6065852642059326,0.795058012008667,0.7476590275764465,0,0,0,0.49521106481552124,0.3347782790660858],"surprised":[0,0,0.0032686882186681032,0.0012177950702607632,0.00044855865417048335,0,0,0,0,0.0011489083990454674,0,0,0.004243765491992235,0.006571643985807896,0.003412101184949279,0,0,0.0012757264776155353,0.000894435157533735,0.0002201296592829749,0,0,0,0.006308706942945719,0.010375620797276497],"neutral":[0,0,0.007824722677469254,0.00000775481566961389,0.000004436909875948913,0,0,0,0,0.00003311681211926043,0,0,0.00029889741563238204,0.000974593625869602,0.001475819735787809,0,0,0.0025359552819281816,0.0018422311404719949,0.0008842840325087309,0,0,0,0.011145612224936485,0.00024206175294239074],"emotion":[0,0,"Angry","Angry","Angry",0,0,0,0,"Angry",0,0,"Angry","Angry","Angry",0,0,"Sad","Sad","Sad",0,0,0,"Sad","Sad"]}');
        {% endif %}

        loadCharts(data);
    });

</script>

{% endblock %}
